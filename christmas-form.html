<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Family Application - Moms On a Mission</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .form-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-section {
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #b2c2bf;
        }

        .form-section h3 {
            margin-top: 0;
            color: #3b3a30;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #3b3a30;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #b2c2bf;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b3a30;
        }

        .child-entry {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 2px solid #c0ded9;
            position: relative;
        }

        .child-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .child-entry-header h4 {
            margin: 0;
            color: #3b3a30;
        }

        .remove-child-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .remove-child-btn:hover {
            background: #c82333;
        }

        .add-child-btn {
            background: #b2c2bf;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background 0.3s;
            width: 100%;
            margin-top: 1rem;
        }

        .add-child-btn:hover {
            background: #3b3a30;
        }

        .submit-btn {
            background: #3b3a30;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }

        .submit-btn:hover {
            background: #b2c2bf;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .message {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }

        .modal-content h3 {
            color: #dc3545;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .modal-content p {
            line-height: 1.8;
            color: #3b3a30;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .modal-btn-cancel:hover {
            background: #5a6268;
        }

        .modal-btn-confirm {
            background: #3b3a30;
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #b2c2bf;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 1.5rem;
            }
            
            .modal-buttons {
                flex-direction: column-reverse;
            }
            
            .modal-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <img src="images/moms logo1.jpg" alt="Moms On a Mission Logo" class="logo-img">
                    <div class="logo-text">
                        <h1>Moms On a Mission</h1>
                        <p class="tagline">Serving Our Community with Love</p>
                    </div>
                </div>
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="missions.html">Missions</a></li>
                    <li><a href="holiday-help.html" class="active">Holiday Help</a></li>
                    <li><a href="donate.html" class="donate-btn">Donate</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <section class="hero">
            <div class="hero-content">
                <h2>Christmas Family Application</h2>
                <p>Providing gifts and hope to families this Christmas season</p>
            </div>
        </section>

        <div class="form-container">
            <div id="statusMessage"></div>
            
            <form id="christmasForm">
                <!-- Adult/Parent Information -->
                <div class="form-section">
                    <h3>Parent/Guardian Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="parentFirstName">First Name *</label>
                            <input type="text" id="parentFirstName" name="parentFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="parentLastName">Last Name *</label>
                            <input type="text" id="parentLastName" name="parentLastName" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="streetAddress">Street Address *</label>
                        <input type="text" id="streetAddress" name="streetAddress" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="zipCode">ZIP Code *</label>
                            <input type="text" id="zipCode" name="zipCode" pattern="[0-9]{5}" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="phoneNumber">Phone Number *</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" pattern="[0-9]{10}" placeholder="1234567890" required>
                        </div>
                        <div class="form-group">
                            <label for="emailAddress">Email Address *</label>
                            <input type="email" id="emailAddress" name="emailAddress" required>
                        </div>
                    </div>
                </div>

                <!-- Children Information -->
                <div class="form-section">
                    <h3>Children Information</h3>
                    <p style="color: #666; margin-bottom: 1.5rem;">Please add each child who will receive gifts (ages 0-17)</p>
                    
                    <div id="childrenContainer">
                        <!-- Child entries will be added here dynamically -->
                    </div>

                    <button type="button" class="add-child-btn" id="addChildBtn">+ Add Child</button>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">Submit Application</button>
            </form>
        </div>
    </main>

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="modal">
        <div class="modal-content">
            <h3>***DISCLAIMER***</h3>
            <p>
                You MUST be the legal guardian for all children that you are listing in your submission. 
                You will be asked to provide documentation when you receive the gifts to verify that you 
                are the legal guardian of every child for which you're shopping.
            </p>
            <div class="modal-buttons">
                <button type="button" class="modal-btn modal-btn-cancel" id="cancelBtn">Cancel</button>
                <button type="button" class="modal-btn modal-btn-confirm" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div style="margin-bottom: 1rem;">
                    <p style="margin: 0;"><strong>Moms On a Mission</strong></p>
                    <p style="margin: 0.25rem 0;">440 McBride Ave, Dupo, IL 62239</p>
                    <p style="margin: 0.25rem 0;">EIN: 36-4837678</p>
                </div>
                <div class="footer-social">
                    <a href="https://www.facebook.com/groups/343793369162470" target="_blank" class="social-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </a>
                </div>
                <p>&copy; 2025 Moms On a Mission. All rights reserved. | 501(c)(3) Non-Profit Public Charity</p>
            </div>
        </div>
    </footer>

    <script>
        // Supabase credentials - TODO: Add your credentials
        const SUPABASE_URL = 'https://fyxsebearstooizcolnw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5eHNlYmVhcnN0b29pemNvbG53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjgzOTAsImV4cCI6MjA3NjIwNDM5MH0.alg1RGNyDpT8thI-yH_RvgneSKS9ZDk3zirlkf-uhBk';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const form = document.getElementById('christmasForm');
        const submitBtn = document.getElementById('submitBtn');
        const statusMessage = document.getElementById('statusMessage');
        const childrenContainer = document.getElementById('childrenContainer');
        const addChildBtn = document.getElementById('addChildBtn');
        const disclaimerModal = document.getElementById('disclaimerModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmBtn = document.getElementById('confirmBtn');

        let childCount = 0;
        let formDataCache = null;

        // Function to create age options for dropdown
        function createAgeOptions() {
            let options = '<option value="">Select Age</option>';
            options += '<option value="<1">Under 1 year</option>';
            for (let i = 1; i <= 17; i++) {
                options += `<option value="${i}">${i}</option>`;
            }
            return options;
        }

        // Function to add a child entry
        function addChild() {
            childCount++;
            const childEntry = document.createElement('div');
            childEntry.className = 'child-entry';
            childEntry.dataset.childId = childCount;
            
            childEntry.innerHTML = `
                <div class="child-entry-header">
                    <h4>Child ${childCount}</h4>
                    <button type="button" class="remove-child-btn" onclick="removeChild(${childCount})">Remove</button>
                </div>
                
                <div class="form-group">
                    <label for="childName${childCount}">Child's Name *</label>
                    <input type="text" id="childName${childCount}" name="childName${childCount}" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="childGender${childCount}">Gender *</label>
                        <select id="childGender${childCount}" name="childGender${childCount}" required>
                            <option value="">Select Gender</option>
                            <option value="Boy">Boy</option>
                            <option value="Girl">Girl</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="childAge${childCount}">Age *</label>
                        <select id="childAge${childCount}" name="childAge${childCount}" required>
                            ${createAgeOptions()}
                        </select>
                    </div>
                </div>
            `;
            
            childrenContainer.appendChild(childEntry);
            updateChildNumbers();
        }

        // Function to remove a child entry
        window.removeChild = function(childId) {
            const childEntry = document.querySelector(`[data-child-id="${childId}"]`);
            if (childEntry) {
                childEntry.remove();
                updateChildNumbers();
            }
        };

        // Function to update child numbers after removal
        function updateChildNumbers() {
            const childEntries = document.querySelectorAll('.child-entry');
            childEntries.forEach((entry, index) => {
                const header = entry.querySelector('h4');
                if (header) {
                    header.textContent = `Child ${index + 1}`;
                }
            });
        }

        // Add child button click event
        addChildBtn.addEventListener('click', addChild);

        // Add first child by default
        addChild();

        // Modal event handlers
        cancelBtn.addEventListener('click', () => {
            disclaimerModal.classList.remove('show');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Application';
            formDataCache = null;
        });

        confirmBtn.addEventListener('click', () => {
            disclaimerModal.classList.remove('show');
            submitApplication();
        });

        // Form submission - show modal first
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Validate that at least one child has been added
            const childEntries = document.querySelectorAll('.child-entry');
            if (childEntries.length === 0) {
                statusMessage.innerHTML = '<div class="message error">Please add at least one child to your application.</div>';
                statusMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Please Review Disclaimer...';
            
            // Show the disclaimer modal
            disclaimerModal.classList.add('show');
        });

        // Actual submission function
        async function submitApplication() {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            statusMessage.innerHTML = '';

            try {
                const formData = new FormData(form);
                const emailAddress = formData.get('emailAddress');
                const phoneNumber = formData.get('phoneNumber');

                // Check for duplicate email address
                const { data: emailCheck, error: emailError } = await supabase
                    .from('christmas_submissions')
                    .select('email_address')
                    .eq('email_address', emailAddress)
                    .limit(1);

                if (emailError && emailError.code !== 'PGRST116') {
                    throw new Error('Failed to verify submission. Please try again.');
                }

                if (emailCheck && emailCheck.length > 0) {
                    statusMessage.innerHTML = '<div class="message error">An application with this email address has already been submitted. If you believe this is an error, please contact us on Facebook.</div>';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Application';
                    statusMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    return;
                }

                // Check for duplicate phone number
                const { data: phoneCheck, error: phoneError } = await supabase
                    .from('christmas_submissions')
                    .select('phone_number')
                    .eq('phone_number', phoneNumber)
                    .limit(1);

                if (phoneError && phoneError.code !== 'PGRST116') {
                    throw new Error('Failed to verify submission. Please try again.');
                }

                if (phoneCheck && phoneCheck.length > 0) {
                    statusMessage.innerHTML = '<div class="message error">An application with this phone number has already been submitted. If you believe this is an error, please contact us on Facebook.</div>';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Application';
                    statusMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    return;
                }

                // Collect children data
                const children = [];
                const childEntries = document.querySelectorAll('.child-entry');
                
                childEntries.forEach((entry) => {
                    const childId = entry.dataset.childId;
                    children.push({
                        name: formData.get(`childName${childId}`),
                        gender: formData.get(`childGender${childId}`),
                        age: formData.get(`childAge${childId}`)
                    });
                });

                // Prepare data for submission
                const parentFirstName = formData.get('parentFirstName');
                const parentLastName = formData.get('parentLastName');
                const parentFullName = `${parentFirstName} ${parentLastName}`;
                
                const data = {
                    parent_name: parentFullName,
                    street_address: formData.get('streetAddress'),
                    city: formData.get('city'),
                    zip_code: formData.get('zipCode'),
                    phone_number: phoneNumber,
                    email_address: emailAddress,
                    children: children,
                    number_of_children: children.length
                };

                // Submit to Supabase
                const { error } = await supabase
                    .from('christmas_submissions')
                    .insert([data]);

                if (error) {
                    throw error;
                }

                // Success!
                statusMessage.innerHTML = '<div class="message success">Application submitted successfully! Thank you for applying. We will contact you soon with more information about gift pickup.</div>';
                form.reset();
                childrenContainer.innerHTML = '';
                childCount = 0;
                addChild(); // Add one child entry for next potential submission
                
                // Scroll to message
                statusMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } catch (error) {
                console.error('Error:', error);
                statusMessage.innerHTML = '<div class="message error">An error occurred while submitting your application. Please try again or contact us on Facebook.</div>';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Application';
            }
        }
    </script>
</body>
</html>
